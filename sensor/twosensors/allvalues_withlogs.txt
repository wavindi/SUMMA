#!/usr/bin/env python3
"""
VL53L5CX All Zones Logging Output
Log includes header line with sensor info and exact start time
"""

import time
from vl53l5cx_ctypes import VL53L5CX

def main():
    print("Initializing VL53L5CX sensor...")
    try:
        sensor = VL53L5CX()
        sensor.set_resolution(4 * 4)
        sensor.set_ranging_frequency_hz(15)
        print("Sensor initialized\n")
    except RuntimeError as e:
        print(f"Failed: {e}")
        return
    
    sensor.start_ranging()
    time.sleep(2.0)
    
    # Generate filename with your pattern
    filename = time.strftime("gen1_%Y_%m_%d_wa9t_%H_%M_%S.txt")
    start_time_str = time.strftime("%Y-%m-%d %H:%M:%S")
    print(f"Logging output to file: {filename}\n")
    
    header = "Time     | Z0   | Z1   | Z2   | Z3   | Z4   | Z5   | Z6   | Z7   | Z8   | Z9   | Z10  | Z11  | Z12  | Z13  | Z14  | Z15  |"
    
    with open(filename, "w") as log_file:
        # Write introductory line with sensor info and start time
        log_file.write(f"using vl53l5cx and the time {start_time_str}\n")
        log_file.write(header + "\n")
        log_file.write("-" * len(header) + "\n")
        
        print(f"using vl53l5cx and the time {start_time_str}")
        print(header)
        print("-" * len(header))
        
        try:
            while True:
                if sensor.data_ready():
                    data = sensor.get_data()
                    timestamp = time.strftime("%H:%M:%S")
                    
                    zone_values = []
                    for i in range(16):
                        try:
                            zone_value = int(data.distance_mm[0][i])
                            zone_values.append(zone_value)
                        except:
                            zone_values.append(0)
                    
                    line = f"{timestamp} |" + "".join(f" {v:4d} |" for v in zone_values)
                    print(line)
                    log_file.write(line + "\n")
                    log_file.flush()
                time.sleep(0.01)
        except KeyboardInterrupt:
            print("\nStopped by user")
        finally:
            sensor.stop_ranging()

if __name__ == "__main__":
    main()
